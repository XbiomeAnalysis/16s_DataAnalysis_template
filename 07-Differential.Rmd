# Differential Analysis


**Loading packages**

```{r, echo=TRUE, results="hide", warning=FALSE, message=FALSE}
library(XMAS2)
library(dplyr)
library(tibble)
library(phyloseq)
library(ggplot2)
library(ggpubr)
library(SummarizedExperiment)
```


There are more than 10 approaches to perform differential analysis. Here, we choose two of them and recommend users going to **Chapter 10** to see more detials.

## Liner discriminant analysis (LDA) effect size (LEfSe)

* Calculation
```{r, warning=FALSE, message=FALSE}
dada2_ps_lefse <- run_lefse(
                    dada2_ps_rare_genus_filter_trim,
                    group = "Group",
                    group_names = c("AA", "BB"),
                    Lda = 1)
head(dada2_ps_lefse)
```

* Visualization
```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4, fig.align="center", fig.cap="Lefse analysis (16s example)"}
plot_lefse(
  da_res = dada2_ps_lefse,
  x_index = "LDA_Score",
  x_index_cutoff = 1,
  group_color = c("green", "red"))
```


## Wilcoxon Rank-Sum test

* Calculation
```{r, warning=FALSE, message=FALSE}
dada2_ps_wilcox <- run_wilcox(
                    dada2_ps_rare_genus_filter_trim,
                    group = "Group",
                    group_names = c("AA", "BB"))

head(dada2_ps_wilcox)
```


* Volcano
```{r, warning=FALSE, message=FALSE, fig.width=8, fig.height=6, fig.align="center", fig.cap="Wilcoxon Rank-Sum test (16s example)"}
plot_volcano(
    dada2_ps_wilcox,
    group_names = c("AA", "BB"),
    x_index = "Log2FoldChange (Rank)\nAA_vs_BB",
    x_index_cutoff = 0.5,
    y_index = "Pvalue",
    y_index_cutoff = 0.05,
    group_color = c("red", "grey", "blue"),
    topN = 5)
```


## Dominant taxa

Display the significant taxa with selection using boxplot.

```{r, warning=FALSE, message=FALSE, fig.align="center", fig.width=8, fig.height=5, fig.cap="Dominant Taxa"}
plot_topN_boxplot(
    ps = dada2_ps_rare_genus_filter_trim,
    da_res = dada2_ps_wilcox,
    x_index = "Log2FoldChange (Rank)\nAA_vs_BB",
    x_index_cutoff = 0.5,
    y_index = "Pvalue",
    y_index_cutoff = 0.05,
    topN = 5,
    group = "Group")
```


## Multiple differential analysis by one function

here, we provide the `run_multiple_da` for obtaining the results list from multiple differential analysis methods.

```{r, warning=FALSE, message=FALSE}
multiple_res <- run_multiple_da(
       dada2_ps_rare_genus_filter_trim,
       group = "Group",
       group_names = c("AA", "BB"),
       da_method = c("aldex", "limma_voom", "mbzinb", "omnibus"))

names(multiple_res)
```


* plot  results
```{r, warning=FALSE, message=FALSE, fig.align="center", fig.width=8, fig.height=13, fig.cap="Multiple DA results"}
plot_multiple_DA(
  Multip_DA_res = multiple_res,
  x_index_list = c("EffectSize", "logFC", "mean.LFC", "abund.LFC.CompvarBB.est"),
  x_index_cutoff = 1,
  y_index = "AdjustedPvalue",
  y_index_cutoff = 0.5,
  cellwidth = 50, 
  cellheight = 15, 
  fontsize_number = 15)
```


## Systematic Information
```{r}
sessionInfo()
```

